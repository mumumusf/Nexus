#!/bin/bash

# Nexus Network ä¸€ä½“åŒ–ç®¡ç†å·¥å…·
# ä½œè€…: @YOYOMYOYOA
# ç‰ˆæœ¬: v4.0.0

# ç¯å¢ƒæ£€æµ‹å‡½æ•°
detect_environment() {
    # æ£€æµ‹æ˜¯å¦åœ¨WSLç¯å¢ƒä¸­
    if grep -qi microsoft /proc/version 2>/dev/null; then
        ENVIRONMENT="WSL"
        echo "ğŸ” æ£€æµ‹åˆ° Windows WSL ç¯å¢ƒ"
    elif [[ -f /proc/version ]]; then
        ENVIRONMENT="LINUX"
        echo "ğŸ” æ£€æµ‹åˆ° Linux ç¯å¢ƒ"
    else
        ENVIRONMENT="UNKNOWN"
        echo "âš ï¸ æœªçŸ¥ç¯å¢ƒï¼Œå°†æŒ‰Linuxæ–¹å¼è¿è¡Œ"
    fi
    
    # æ£€æµ‹å‘è¡Œç‰ˆ
    if command -v lsb_release >/dev/null 2>&1; then
        DISTRO=$(lsb_release -si 2>/dev/null)
    elif [[ -f /etc/os-release ]]; then
        DISTRO=$(grep '^ID=' /etc/os-release | cut -d= -f2 | tr -d '"')
    else
        DISTRO="unknown"
    fi
    
    echo "ğŸ’» ç¯å¢ƒä¿¡æ¯: $ENVIRONMENT ($DISTRO)"
    echo ""
}

# æ ¹æ®ç¯å¢ƒè°ƒæ•´å‘½ä»¤
get_package_manager() {
    if command -v apt >/dev/null 2>&1; then
        echo "apt"
    elif command -v yum >/dev/null 2>&1; then
        echo "yum"
    elif command -v dnf >/dev/null 2>&1; then
        echo "dnf"
    elif command -v pacman >/dev/null 2>&1; then
        echo "pacman"
    else
        echo "unknown"
    fi
}

# æ£€æŸ¥sudoæƒé™
check_sudo() {
    if [[ $EUID -eq 0 ]]; then
        SUDO_CMD=""
        echo "âœ… å½“å‰ä¸ºrootç”¨æˆ·"
    elif sudo -n true 2>/dev/null; then
        SUDO_CMD="sudo"
        echo "âœ… sudoæƒé™å¯ç”¨"
    else
        echo "âš ï¸ éœ€è¦sudoæƒé™æ¥å®‰è£…ç³»ç»Ÿä¾èµ–"
        echo "è¯·ç¡®ä¿å½“å‰ç”¨æˆ·æœ‰sudoæƒé™ï¼Œæˆ–ä»¥rootç”¨æˆ·è¿è¡Œ"
        SUDO_CMD="sudo"
    fi
}

# æ˜¾ç¤ºä¸»è¦banner
show_main_banner() {
    echo "
â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘
 â•šâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘
 â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
â•šâ•â•  â•šâ•â•â•šâ•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•â•šâ•â•  â•šâ•â•â•â•

    === Nexus Network ä¸€ä½“åŒ–ç®¡ç†å·¥å…· ===
    æ”¯æŒ Linux å’Œ Windows WSL ç¯å¢ƒ
** ====================================== **
*         æ­¤è„šæœ¬ä»…ä¾›å…è´¹ä½¿ç”¨              *
*         ç¦æ­¢å‡ºå”®æˆ–ç”¨äºç›ˆåˆ©              *
** ====================================== **

* ä½œè€…: @YOYOMYOYOA
* ç©ºæŠ•ç©å®¶ | ç°è´§ç©å®¶ | memeæ”¶è—
* Github: github.com/mumumusf

** ====================================== **
*            å…è´£å£°æ˜                      *
* æ­¤è„šæœ¬ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨                  *
* ä½¿ç”¨æœ¬è„šæœ¬æ‰€äº§ç”Ÿçš„ä»»ä½•åæœç”±ç”¨æˆ·è‡ªè¡Œæ‰¿æ‹… *
* å¦‚æœå› ä½¿ç”¨æœ¬è„šæœ¬é€ æˆä»»ä½•æŸå¤±ï¼Œä½œè€…æ¦‚ä¸è´Ÿè´£*
** ====================================== **
"
}

# å†…å­˜æ£€æµ‹å‡½æ•°
detect_memory() {
    echo "ğŸ” æ­£åœ¨æ£€æµ‹ç³»ç»Ÿå†…å­˜..."
    
    # è·å–æ€»å†…å­˜ï¼ˆå•ä½ï¼šGBï¼‰
    if [[ -f /proc/meminfo ]]; then
        total_memory_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
        total_memory_gb=$((total_memory_kb / 1024 / 1024))
        
        # è·å–å¯ç”¨å†…å­˜ï¼ˆå•ä½ï¼šGBï¼‰
        available_memory_kb=$(grep MemAvailable /proc/meminfo | awk '{print $2}')
        available_memory_gb=$((available_memory_kb / 1024 / 1024))
    else
        echo "âŒ æ— æ³•è¯»å–å†…å­˜ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
        total_memory_gb=8
        available_memory_gb=6
    fi
    
    echo "ğŸ’¾ ç³»ç»Ÿæ€»å†…å­˜: ${total_memory_gb}GB"
    echo "ğŸ’¿ å¯ç”¨å†…å­˜: ${available_memory_gb}GB"
    
    # æ ¹æ®å†…å­˜è®¡ç®—æ¨èèŠ‚ç‚¹æ•°ï¼ˆæ¯ä¸ªèŠ‚ç‚¹å»ºè®®4GBï¼Œä½†ä¿ç•™2GBç»™ç³»ç»Ÿï¼‰
    if [ $total_memory_gb -ge 6 ]; then
        recommended_nodes=$(((total_memory_gb - 2) / 4))
        if [ $recommended_nodes -lt 1 ]; then
            recommended_nodes=1
        fi
    else
        recommended_nodes=1
    fi
    
    echo "ğŸ¯ æ¨èèŠ‚ç‚¹æ•°é‡: ${recommended_nodes} ä¸ªèŠ‚ç‚¹"
    echo "ğŸ“Š å†…å­˜åˆ†é…ç­–ç•¥: æ¯èŠ‚ç‚¹4GBï¼Œç³»ç»Ÿä¿ç•™2GB"
    echo ""
    
    return $recommended_nodes
}

# å®‰è£…ç³»ç»Ÿä¾èµ–
install_system_dependencies() {
    echo "ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–..."
    
    PKG_MANAGER=$(get_package_manager)
    
    case $PKG_MANAGER in
        "apt")
            echo "ğŸ”„ æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
            $SUDO_CMD apt update
            echo "ğŸ“¥ å®‰è£…ä¾èµ–åŒ…..."
            $SUDO_CMD apt install -y protobuf-compiler curl build-essential
            ;;
        "yum")
            echo "ğŸ“¥ å®‰è£…ä¾èµ–åŒ…..."
            $SUDO_CMD yum install -y protobuf-compiler curl gcc gcc-c++ make
            ;;
        "dnf")
            echo "ğŸ“¥ å®‰è£…ä¾èµ–åŒ…..."
            $SUDO_CMD dnf install -y protobuf-compiler curl gcc gcc-c++ make
            ;;
        "pacman")
            echo "ğŸ”„ æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
            $SUDO_CMD pacman -Sy
            echo "ğŸ“¥ å®‰è£…ä¾èµ–åŒ…..."
            $SUDO_CMD pacman -S --noconfirm protobuf curl base-devel
            ;;
        *)
            echo "âŒ æœªçŸ¥çš„åŒ…ç®¡ç†å™¨ï¼Œè¯·æ‰‹åŠ¨å®‰è£…ä»¥ä¸‹ä¾èµ–ï¼š"
            echo "  - protobuf-compiler"
            echo "  - curl"
            echo "  - build-essential (æˆ–ç­‰æ•ˆçš„ç¼–è¯‘å·¥å…·)"
            return 1
            ;;
    esac
    
    echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
    return 0
}

# å®‰è£…screen
install_screen() {
    if ! command -v screen &> /dev/null; then
        echo "ğŸ“º æ­£åœ¨å®‰è£… screen..."
        
        PKG_MANAGER=$(get_package_manager)
        
        case $PKG_MANAGER in
            "apt")
                $SUDO_CMD apt install -y screen
                ;;
            "yum")
                $SUDO_CMD yum install -y screen
                ;;
            "dnf")
                $SUDO_CMD dnf install -y screen
                ;;
            "pacman")
                $SUDO_CMD pacman -S --noconfirm screen
                ;;
            *)
                echo "âŒ æ— æ³•è‡ªåŠ¨å®‰è£…screenï¼Œè¯·æ‰‹åŠ¨å®‰è£…"
                return 1
                ;;
        esac
        
        echo "âœ… screen å®‰è£…å®Œæˆï¼"
    else
        echo "âœ… screen å·²å®‰è£…"
    fi
    
    return 0
}

# å®‰è£…èŠ‚ç‚¹åŠŸèƒ½
install_nodes() {
    echo "
    === Nexus è‡ªåŠ¨åŒ–å®‰è£…å·¥å…· (å¤šå¼€ç‰ˆ) ===
"
    
    # æ£€æµ‹ç¯å¢ƒ
    detect_environment
    
    # æ£€æŸ¥sudoæƒé™
    check_sudo
    
    # æ£€æµ‹ç³»ç»Ÿå†…å­˜
    detect_memory
    recommended_nodes=$?

    # å®‰è£…screen
    if ! install_screen; then
        return 1
    fi

    # å®‰è£…ç³»ç»Ÿä¾èµ–
    if ! install_system_dependencies; then
        return 1
    fi

    # å®‰è£… Rust
    echo "ğŸ¦€ å®‰è£… Rust..."
    if ! command -v rustc &> /dev/null; then
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
        echo "âœ… Rust å®‰è£…å®Œæˆ"
    else
        echo "âœ… Rust å·²å®‰è£…"
        source $HOME/.cargo/env 2>/dev/null || true
    fi

    # è®¾ç½® Rust é»˜è®¤ç‰ˆæœ¬
    echo "âš™ï¸ è®¾ç½® Rust é»˜è®¤ç‰ˆæœ¬..."
    rustup default stable
    echo "âœ… Rust é»˜è®¤ç‰ˆæœ¬è®¾ç½®å®Œæˆ"

    # å®‰è£… nexus-cli
    echo "ğŸ“¥ å®‰è£… nexus-cli..."
    echo "æ³¨æ„ï¼šå¦‚æœå‡ºç°æ¡æ¬¾ç¡®è®¤æç¤ºï¼Œè¯·è¾“å…¥ 'y' ç¡®è®¤"
    curl https://cli.nexus.xyz | sh
    echo "âœ… nexus-cli å®‰è£…å®Œæˆ"

    # æ·»åŠ  PATH ç¯å¢ƒå˜é‡
    echo "ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡..."
    
    # æ£€æµ‹ä½¿ç”¨çš„shell
    if [[ $SHELL == *"zsh"* ]]; then
        SHELL_RC="$HOME/.zshrc"
    else
        SHELL_RC="$HOME/.bashrc"
    fi
    
    # æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ PATH
    if ! grep -q ".nexus/bin" $SHELL_RC 2>/dev/null; then
        echo 'export PATH="$HOME/.nexus/bin:$PATH"' >> $SHELL_RC
        echo "âœ… å·²æ·»åŠ åˆ° $SHELL_RC"
    else
        echo "âœ… PATH å·²é…ç½®"
    fi
    
    source $SHELL_RC 2>/dev/null || source ~/.bashrc 2>/dev/null || true
    export PATH="$HOME/.nexus/bin:$PATH"
    echo "âœ… ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"

    echo "ğŸ‰ nexus-cli åŠå…¶ä¾èµ–å®‰è£…å®Œæˆï¼"

    # è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦å»ºç«‹ä¼šè¯
    echo ""
    echo "=== å®‰è£…å®Œæˆ ==="
    echo "nexus-cli å·²å‡†å¤‡å°±ç»ªï¼"
    echo ""
    read -p "æ˜¯å¦è¦å»ºç«‹ Screen ä¼šè¯è¿è¡ŒèŠ‚ç‚¹ï¼Ÿ(y/n): " create_session

    if [[ $create_session != "y" && $create_session != "Y" ]]; then
        echo "å¥½çš„ï¼Œæ‚¨å¯ä»¥ç¨åæ‰‹åŠ¨è¿è¡ŒèŠ‚ç‚¹ã€‚"
        echo "æ‰‹åŠ¨è¿è¡Œå‘½ä»¤ï¼šnexus-network start --node-id <æ‚¨çš„èŠ‚ç‚¹ID>"
        return 0
    fi

    # è·å–èŠ‚ç‚¹æ•°é‡å’ŒID
    echo ""
    echo "=== å¤šå¼€èŠ‚ç‚¹é…ç½® ==="
    echo "ğŸ¯ ç³»ç»Ÿæ¨èè¿è¡Œ ${recommended_nodes} ä¸ªèŠ‚ç‚¹"
    echo ""
    read -p "è¯·è¾“å…¥è¦è¿è¡Œçš„èŠ‚ç‚¹æ•°é‡ (1-${recommended_nodes}): " node_count

    # éªŒè¯èŠ‚ç‚¹æ•°é‡
    if ! [[ "$node_count" =~ ^[0-9]+$ ]] || [ "$node_count" -lt 1 ] || [ "$node_count" -gt "$recommended_nodes" ]; then
        echo "âŒ é”™è¯¯ï¼šèŠ‚ç‚¹æ•°é‡å¿…é¡»æ˜¯ 1-${recommended_nodes} ä¹‹é—´çš„æ•°å­—"
        echo "æ ¹æ®æ‚¨çš„å†…å­˜é…ç½®ï¼Œå»ºè®®ä¸è¦è¶…è¿‡æ¨èæ•°é‡"
        return 1
    fi

    echo "âœ… å°†è¿è¡Œ ${node_count} ä¸ªèŠ‚ç‚¹"
    echo ""

    # è·å–èŠ‚ç‚¹IDåˆ—è¡¨
    declare -a NODE_IDS
    echo "è¯·ä¾æ¬¡è¾“å…¥ ${node_count} ä¸ªèŠ‚ç‚¹IDï¼ˆçº¯æ•°å­—ï¼‰:"

    for ((i=1; i<=node_count; i++)); do
        while true; do
            read -p "èŠ‚ç‚¹ $i ID: " node_id
            
            # æ¸…ç†è¾“å…¥ï¼ˆå»é™¤ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦ï¼‰
            node_id=$(echo "$node_id" | tr -d '[:space:]')
            
            # éªŒè¯èŠ‚ç‚¹ID
            if [ -z "$node_id" ]; then
                echo "âŒ é”™è¯¯ï¼šèŠ‚ç‚¹IDä¸èƒ½ä¸ºç©ºï¼Œè¯·é‡æ–°è¾“å…¥"
                continue
            fi
            
            # æ£€æŸ¥æ˜¯å¦åªåŒ…å«æ•°å­—
            if ! [[ "$node_id" =~ ^[0-9]+$ ]]; then
                echo "âŒ é”™è¯¯ï¼šèŠ‚ç‚¹IDåº”è¯¥åªåŒ…å«æ•°å­—ï¼Œè¯·é‡æ–°è¾“å…¥"
                continue
            fi
            
            # æ£€æŸ¥æ˜¯å¦é‡å¤
            duplicate=false
            for existing_id in "${NODE_IDS[@]}"; do
                if [ "$existing_id" = "$node_id" ]; then
                    echo "âŒ é”™è¯¯ï¼šèŠ‚ç‚¹ID $node_id å·²å­˜åœ¨ï¼Œè¯·è¾“å…¥ä¸åŒçš„ID"
                    duplicate=true
                    break
                fi
            done
            
            if [ "$duplicate" = false ]; then
                NODE_IDS+=("$node_id")
                echo "âœ… èŠ‚ç‚¹ $i IDéªŒè¯é€šè¿‡: $node_id"
                break
            fi
        done
    done

    echo ""
    echo "ğŸ“‹ èŠ‚ç‚¹é…ç½®æ‘˜è¦:"
    for ((i=0; i<${#NODE_IDS[@]}; i++)); do
        echo "  èŠ‚ç‚¹ $((i+1)): ${NODE_IDS[$i]}"
    done

    # æ£€æŸ¥ç°æœ‰ä¼šè¯å¹¶å¯åŠ¨å¤šä¸ªèŠ‚ç‚¹
    echo ""
    echo "=== å¯åŠ¨å¤šä¸ªèŠ‚ç‚¹ ==="

    # æ£€æŸ¥æ˜¯å¦æœ‰å†²çªçš„ä¼šè¯
    conflicting_sessions=()
    for node_id in "${NODE_IDS[@]}"; do
        session_name="nexus_${node_id}"
        if screen -list 2>/dev/null | grep -q "$session_name"; then
            conflicting_sessions+=("$session_name")
        fi
    done

    # å¤„ç†å†²çªä¼šè¯
    if [ ${#conflicting_sessions[@]} -gt 0 ]; then
        echo "âš ï¸ å‘ç°å·²å­˜åœ¨çš„ä¼šè¯:"
        for session in "${conflicting_sessions[@]}"; do
            echo "  - $session"
        done
        echo ""
        read -p "æ˜¯å¦è¦ç»ˆæ­¢ç°æœ‰ä¼šè¯å¹¶åˆ›å»ºæ–°ä¼šè¯ï¼Ÿ(y/n): " choice
        if [[ $choice == "y" || $choice == "Y" ]]; then
            for session in "${conflicting_sessions[@]}"; do
                echo "ğŸ—‘ï¸ ç»ˆæ­¢ä¼šè¯: $session"
                screen -S "$session" -X quit 2>/dev/null
            done
        else
            echo "âŒ æ“ä½œå–æ¶ˆ"
            return 0
        fi
    fi

    # å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹
    echo "ğŸš€ å¼€å§‹å¯åŠ¨ ${#NODE_IDS[@]} ä¸ªèŠ‚ç‚¹..."
    echo ""

    # åˆ›å»ºå¯åŠ¨è„šæœ¬
    for ((i=0; i<${#NODE_IDS[@]}; i++)); do
        node_id="${NODE_IDS[$i]}"
        session_name="nexus_${node_id}"
        
        echo "ğŸ“¡ å¯åŠ¨èŠ‚ç‚¹ $((i+1))/${#NODE_IDS[@]}: $node_id"
        
        # åœ¨screenä¼šè¯ä¸­è¿è¡ŒèŠ‚ç‚¹
        screen -dmS "$session_name" bash -c "
    export PATH=\"\$HOME/.nexus/bin:\$PATH\"
    echo '=== Nexus èŠ‚ç‚¹è¿è¡Œä¸­ ==='
    echo 'èŠ‚ç‚¹ID: $node_id'
    echo 'ä¼šè¯åç§°: $session_name'
    echo 'èŠ‚ç‚¹åºå·: $((i+1))/${#NODE_IDS[@]}'
    echo 'å¼€å§‹æ—¶é—´: \$(date)'
    echo 'å†…å­˜åˆ†é…: 4GB (æ¨è)'
    echo 'ç¯å¢ƒ: $ENVIRONMENT'
    echo ''

    echo \"\$(date): å¯åŠ¨èŠ‚ç‚¹ $node_id\"
    nexus-network start --node-id \"$node_id\"
    "
        
        echo "âœ… èŠ‚ç‚¹ $node_id å·²åœ¨Screenä¼šè¯ä¸­å¯åŠ¨ï¼"
        
        # æ·»åŠ å¯åŠ¨é—´éš”ï¼Œé¿å…åŒæ—¶å¯åŠ¨é€ æˆèµ„æºå†²çª
        if [ $((i+1)) -lt ${#NODE_IDS[@]} ]; then
            echo "â³ ç­‰å¾…3ç§’åå¯åŠ¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹..."
            sleep 3
        fi
    done

    echo ""
    echo "ğŸ‰ æ‰€æœ‰èŠ‚ç‚¹å¯åŠ¨å®Œæˆï¼"
    echo ""
    echo "ğŸ“‹ èŠ‚ç‚¹ç®¡ç†å‘½ä»¤ï¼š"
    echo "â€¢ æŸ¥çœ‹æ‰€æœ‰ä¼šè¯: screen -list"
    echo "â€¢ è¿æ¥åˆ°æŒ‡å®šèŠ‚ç‚¹: screen -r nexus_<èŠ‚ç‚¹ID>"
    echo "â€¢ åˆ†ç¦»ä¼šè¯: åœ¨ä¼šè¯ä¸­æŒ‰ Ctrl+A ç„¶åæŒ‰ D"
    echo "â€¢ åœæ­¢æŒ‡å®šèŠ‚ç‚¹: screen -S nexus_<èŠ‚ç‚¹ID> -X quit"
    echo "â€¢ ä½¿ç”¨ç®¡ç†å·¥å…·: bash yoyom"
    echo ""

    # åˆ›å»ºåœæ­¢æ‰€æœ‰èŠ‚ç‚¹çš„è„šæœ¬
    cat > stop_all_nodes.sh << 'EOF'
#!/bin/bash
echo "ğŸ›‘ åœæ­¢æ‰€æœ‰ Nexus èŠ‚ç‚¹..."
for session in $(screen -list 2>/dev/null | grep nexus_ | awk '{print $1}'); do
    echo "åœæ­¢ä¼šè¯: $session"
    screen -S "$session" -X quit 2>/dev/null
done
echo "âœ… æ‰€æœ‰èŠ‚ç‚¹å·²åœæ­¢"
EOF

    chmod +x stop_all_nodes.sh 2>/dev/null || true

    echo "ğŸ“Š å½“å‰è¿è¡Œçš„èŠ‚ç‚¹:"
    for node_id in "${NODE_IDS[@]}"; do
        echo "  - èŠ‚ç‚¹ $node_id: screen -r nexus_$node_id"
    done

    echo ""
    echo "ğŸŒ ç°åœ¨æ‚¨å¯ä»¥å®‰å…¨åœ°å…³é—­SSHè¿æ¥ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¼šç»§ç»­è¿è¡Œï¼"
    echo "ğŸ“ å·²åˆ›å»º stop_all_nodes.sh è„šæœ¬ç”¨äºä¸€é”®åœæ­¢æ‰€æœ‰èŠ‚ç‚¹"
    echo "ğŸ› ï¸ è¿è¡Œ 'bash yoyom' è¿›å…¥èŠ‚ç‚¹ç®¡ç†ç•Œé¢"
}

# ===== èŠ‚ç‚¹ç®¡ç†åŠŸèƒ½ =====

# æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
check_nodes_status() {
    echo "ğŸ“Š æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€..."
    echo ""
    
    nexus_sessions=$(screen -list 2>/dev/null | grep nexus_ | awk '{print $1}')
    
    if [ -z "$nexus_sessions" ]; then
        echo "âŒ æ²¡æœ‰å‘ç°è¿è¡Œä¸­çš„ Nexus èŠ‚ç‚¹"
        return
    fi
    
    echo "âœ… è¿è¡Œä¸­çš„èŠ‚ç‚¹:"
    echo ""
    
    count=1
    for session in $nexus_sessions; do
        node_id=$(echo "$session" | sed 's/.*nexus_//' | sed 's/\..*$//')
        echo "  $count. èŠ‚ç‚¹ID: $node_id"
        echo "     ä¼šè¯å: $session"
        echo "     è¿æ¥å‘½ä»¤: screen -r $session"
        echo ""
        ((count++))
    done
    
    echo "æ€»è®¡: $((count-1)) ä¸ªèŠ‚ç‚¹è¿è¡Œä¸­"
}

# åœæ­¢æŒ‡å®šèŠ‚ç‚¹
stop_node() {
    read -p "è¯·è¾“å…¥è¦åœæ­¢çš„èŠ‚ç‚¹ID: " node_id
    
    if [ -z "$node_id" ]; then
        echo "âŒ èŠ‚ç‚¹IDä¸èƒ½ä¸ºç©º"
        return
    fi
    
    session_name="nexus_${node_id}"
    
    if screen -list 2>/dev/null | grep -q "$session_name"; then
        echo "ğŸ›‘ åœæ­¢èŠ‚ç‚¹ $node_id..."
        screen -S "$session_name" -X quit 2>/dev/null
        echo "âœ… èŠ‚ç‚¹ $node_id å·²åœæ­¢"
    else
        echo "âŒ æœªæ‰¾åˆ°èŠ‚ç‚¹ $node_id çš„è¿è¡Œä¼šè¯"
    fi
}

# åœæ­¢æ‰€æœ‰èŠ‚ç‚¹
stop_all_nodes() {
    echo "ğŸ›‘ åœæ­¢æ‰€æœ‰ Nexus èŠ‚ç‚¹..."
    
    nexus_sessions=$(screen -list 2>/dev/null | grep nexus_ | awk '{print $1}')
    
    if [ -z "$nexus_sessions" ]; then
        echo "âŒ æ²¡æœ‰å‘ç°è¿è¡Œä¸­çš„ Nexus èŠ‚ç‚¹"
        return
    fi
    
    for session in $nexus_sessions; do
        node_id=$(echo "$session" | sed 's/.*nexus_//' | sed 's/\..*$//')
        echo "åœæ­¢èŠ‚ç‚¹: $node_id"
        screen -S "$session" -X quit 2>/dev/null
    done
    
    echo "âœ… æ‰€æœ‰èŠ‚ç‚¹å·²åœæ­¢"
}

# è¿æ¥åˆ°æŒ‡å®šèŠ‚ç‚¹
connect_to_node() {
    check_nodes_status
    
    if [ "$(screen -list 2>/dev/null | grep nexus_ | wc -l)" -eq 0 ]; then
        return
    fi
    
    read -p "è¯·è¾“å…¥è¦è¿æ¥çš„èŠ‚ç‚¹ID: " node_id
    
    if [ -z "$node_id" ]; then
        echo "âŒ èŠ‚ç‚¹IDä¸èƒ½ä¸ºç©º"
        return
    fi
    
    session_name="nexus_${node_id}"
    
    if screen -list 2>/dev/null | grep -q "$session_name"; then
        echo "ğŸ”— è¿æ¥åˆ°èŠ‚ç‚¹ $node_id..."
        echo "æç¤º: æŒ‰ Ctrl+A ç„¶å D åˆ†ç¦»ä¼šè¯"
        screen -r "$session_name"
    else
        echo "âŒ æœªæ‰¾åˆ°èŠ‚ç‚¹ $node_id çš„è¿è¡Œä¼šè¯"
    fi
}

# æ˜¾ç¤ºç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
show_system_resources() {
    echo "ğŸ’» ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ:"
    echo ""
    
    # æ£€æµ‹ç¯å¢ƒ
    detect_environment
    
    # å†…å­˜ä½¿ç”¨æƒ…å†µ
    if [[ -f /proc/meminfo ]]; then
        total_memory_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
        available_memory_kb=$(grep MemAvailable /proc/meminfo | awk '{print $2}')
        used_memory_kb=$((total_memory_kb - available_memory_kb))
        
        total_memory_gb=$((total_memory_kb / 1024 / 1024))
        used_memory_gb=$((used_memory_kb / 1024 / 1024))
        available_memory_gb=$((available_memory_kb / 1024 / 1024))
        
        memory_usage_percent=$((used_memory_gb * 100 / total_memory_gb))
        
        echo "ğŸ“Š å†…å­˜ä½¿ç”¨:"
        echo "  æ€»å†…å­˜: ${total_memory_gb}GB"
        echo "  å·²ä½¿ç”¨: ${used_memory_gb}GB (${memory_usage_percent}%)"
        echo "  å¯ç”¨å†…å­˜: ${available_memory_gb}GB"
    else
        echo "âŒ æ— æ³•è¯»å–å†…å­˜ä¿¡æ¯"
    fi
    echo ""
    
    # CPUä½¿ç”¨æƒ…å†µ
    if command -v top >/dev/null 2>&1; then
        cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//' 2>/dev/null || echo "N/A")
        echo "ğŸ–¥ï¸ CPUä½¿ç”¨ç‡: ${cpu_usage}%"
    else
        echo "ğŸ–¥ï¸ CPUä½¿ç”¨ç‡: æ— æ³•è·å–"
    fi
    echo ""
    
    # ç£ç›˜ä½¿ç”¨æƒ…å†µ
    echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨:"
    if command -v df >/dev/null 2>&1; then
        df -h / 2>/dev/null | tail -1 | awk '{print "  æ ¹ç›®å½•: " $3 "/" $2 " (" $5 " å·²ä½¿ç”¨)")' || echo "  æ— æ³•è·å–ç£ç›˜ä¿¡æ¯"
    else
        echo "  æ— æ³•è·å–ç£ç›˜ä¿¡æ¯"
    fi
    echo ""
    
    # è¿è¡Œä¸­çš„èŠ‚ç‚¹æ•°é‡
    nexus_count=$(screen -list 2>/dev/null | grep nexus_ | wc -l)
    echo "ğŸš€ è¿è¡Œä¸­çš„èŠ‚ç‚¹: ${nexus_count} ä¸ª"
    
    if [ $nexus_count -gt 0 ]; then
        estimated_memory=$((nexus_count * 4))
        echo "ğŸ“ˆ é¢„ä¼°èŠ‚ç‚¹å†…å­˜ä½¿ç”¨: ${estimated_memory}GB"
    fi
}

# ç®¡ç†èœå•
show_management_menu() {
    echo ""
    echo "============= èŠ‚ç‚¹ç®¡ç†èœå• =============="
    echo "1. ğŸ“Š æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€"
    echo "2. ğŸ”— è¿æ¥åˆ°æŒ‡å®šèŠ‚ç‚¹"
    echo "3. ğŸ›‘ åœæ­¢æŒ‡å®šèŠ‚ç‚¹"
    echo "4. ğŸš« åœæ­¢æ‰€æœ‰èŠ‚ç‚¹"
    echo "5. ğŸ’» æŸ¥çœ‹ç³»ç»Ÿèµ„æº"
    echo "6. ğŸ”„ åˆ·æ–°èœå•"
    echo "9. ğŸ”™ è¿”å›ä¸»èœå•"
    echo "0. ğŸšª é€€å‡º"
    echo "====================================="
    echo ""
}

# èŠ‚ç‚¹ç®¡ç†ä¸»ç¨‹åº
manage_nodes() {
    echo "
    === Nexus èŠ‚ç‚¹ç®¡ç†å·¥å…· ===
"
    
    while true; do
        show_management_menu
        read -p "è¯·é€‰æ‹©æ“ä½œ (0-6,9): " choice
        
        case $choice in
            1)
                check_nodes_status
                ;;
            2)
                connect_to_node
                ;;
            3)
                stop_node
                ;;
            4)
                read -p "ç¡®è®¤åœæ­¢æ‰€æœ‰èŠ‚ç‚¹ï¼Ÿ(y/n): " confirm
                if [[ $confirm == "y" || $confirm == "Y" ]]; then
                    stop_all_nodes
                fi
                ;;
            5)
                show_system_resources
                ;;
            6)
                clear
                show_main_banner
                echo "
    === Nexus èŠ‚ç‚¹ç®¡ç†å·¥å…· ===
"
                ;;
            9)
                return 0
                ;;
            0)
                echo "ğŸ‘‹ å†è§ï¼"
                exit 0
                ;;
            *)
                echo "âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 0-6 æˆ– 9"
                ;;
        esac
        
        echo ""
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
    done
}

# ä¸»èœå•
show_main_menu() {
    echo ""
    echo "=============== ä¸»èœå• ==============="
    echo "1. ğŸš€ å®‰è£…å¹¶å¯åŠ¨ Nexus èŠ‚ç‚¹"
    echo "2. ğŸ› ï¸ ç®¡ç†ç°æœ‰èŠ‚ç‚¹"
    echo "3. ğŸ’» æŸ¥çœ‹ç³»ç»Ÿèµ„æº"
    echo "4. â„¹ï¸ æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    echo "0. ğŸšª é€€å‡º"
    echo "===================================="
    echo ""
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo "
ğŸ“– === Nexus Network ä¸€ä½“åŒ–ç®¡ç†å·¥å…·å¸®åŠ© ===

ğŸŒ æ”¯æŒç¯å¢ƒ:
  â€¢ Linux (Ubuntu/CentOS/Debian/Arch Linux)
  â€¢ Windows WSL (Windows Subsystem for Linux)

ğŸš€ ä¸»è¦åŠŸèƒ½:
  1. è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿå†…å­˜å¹¶æ¨èèŠ‚ç‚¹æ•°é‡
  2. ä¸€é”®å®‰è£… nexus-cli å’Œç›¸å…³ä¾èµ–
  3. æ”¯æŒå¤šä¸ªèŠ‚ç‚¹åŒæ—¶è¿è¡Œ
  4. å®Œæ•´çš„èŠ‚ç‚¹ç®¡ç†åŠŸèƒ½
  5. å®æ—¶ç³»ç»Ÿèµ„æºç›‘æ§
  6. æ™ºèƒ½ç¯å¢ƒæ£€æµ‹å’Œé€‚é…

ğŸ“‹ ä½¿ç”¨æµç¨‹:
  1. é¦–æ¬¡ä½¿ç”¨é€‰æ‹© 'å®‰è£…å¹¶å¯åŠ¨ Nexus èŠ‚ç‚¹'
  2. æŒ‰ç…§æç¤ºè¾“å…¥èŠ‚ç‚¹æ•°é‡å’Œ ID
  3. åç»­ä½¿ç”¨é€‰æ‹© 'ç®¡ç†ç°æœ‰èŠ‚ç‚¹' è¿›è¡Œç®¡ç†

ğŸ”§ å¸¸ç”¨å‘½ä»¤:
  â€¢ å¯åŠ¨å·¥å…·: bash yoyom
  â€¢ æŸ¥çœ‹æ‰€æœ‰ä¼šè¯: screen -list
  â€¢ è¿æ¥åˆ°èŠ‚ç‚¹: screen -r nexus_<èŠ‚ç‚¹ID>
  â€¢ åˆ†ç¦»ä¼šè¯: Ctrl+A ç„¶å D
  â€¢ åœæ­¢å•ä¸ªèŠ‚ç‚¹: screen -S nexus_<èŠ‚ç‚¹ID> -X quit
  â€¢ åœæ­¢æ‰€æœ‰èŠ‚ç‚¹: bash stop_all_nodes.sh

ğŸ’¾ å†…å­˜è¦æ±‚:
  â€¢ æ¯ä¸ªèŠ‚ç‚¹éœ€è¦ 4GB å†…å­˜
  â€¢ ç³»ç»Ÿä¿ç•™ 2GB å†…å­˜
  â€¢ ä¾‹å¦‚: 10GB å†…å­˜å¯è¿è¡Œ 2 ä¸ªèŠ‚ç‚¹

â“ è·å–èŠ‚ç‚¹ID:
  è®¿é—® https://nexus.xyz æ³¨å†Œå¹¶åˆ›å»ºèŠ‚ç‚¹

âš ï¸ æ³¨æ„äº‹é¡¹:
  â€¢ èŠ‚ç‚¹ID å¿…é¡»æ˜¯çº¯æ•°å­—
  â€¢ ä¸è¦è¶…è¿‡ç³»ç»Ÿæ¨èçš„èŠ‚ç‚¹æ•°é‡
  â€¢ SSH æ–­å¼€åèŠ‚ç‚¹ä¼šç»§ç»­è¿è¡Œ
  â€¢ WSLç”¨æˆ·è¯·ç¡®ä¿å·²å®‰è£…Linuxå‘è¡Œç‰ˆ

ğŸ”§ WSLç¯å¢ƒè¯´æ˜:
  â€¢ åœ¨Windowsä¸Šéœ€è¦å…ˆå®‰è£…WSL
  â€¢ æ¨èä½¿ç”¨Ubuntuæˆ–Debianå‘è¡Œç‰ˆ
  â€¢ ç¡®ä¿WSLç‰ˆæœ¬ä¸ºWSL2
"
}

# ä¸»ç¨‹åº
main() {
    show_main_banner
    
    while true; do
        show_main_menu
        read -p "è¯·é€‰æ‹©æ“ä½œ (0-4): " choice
        
        case $choice in
            1)
                install_nodes
                ;;
            2)
                manage_nodes
                ;;
            3)
                show_system_resources
                echo ""
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            4)
                show_help
                echo ""
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            0)
                echo "ğŸ‘‹ æ„Ÿè°¢ä½¿ç”¨ Nexus Network ä¸€ä½“åŒ–ç®¡ç†å·¥å…·ï¼"
                exit 0
                ;;
            *)
                echo "âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 0-4"
                ;;
        esac
        
        echo ""
    done
}

# æ£€æŸ¥å‚æ•°å¹¶è¿è¡Œ
if [ "$1" = "--install" ]; then
    # ç›´æ¥å®‰è£…æ¨¡å¼
    show_main_banner
    install_nodes
elif [ "$1" = "--manage" ]; then
    # ç›´æ¥ç®¡ç†æ¨¡å¼
    show_main_banner
    manage_nodes
else
    # äº¤äº’æ¨¡å¼
    main
fi 